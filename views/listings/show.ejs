<% layout("layouts/boilerplate") %>

<div class="container py-4">
  <div class="row">

    <!-- LEFT CONTENT: Description, Map, Reviews -->
    <div class="col-lg-8">

      <!-- IMAGE BANNER -->
      <div class="show-banner mb-4">
        <img src="<%= listing.image.url %>" class="show-main-img" alt="listing">
      </div>

      <!-- TITLE + OWNER + LOCATION + CATEGORY + RATING -->
      <h2 class="fw-bold d-flex align-items-center justify-content-between">
        <%= listing.title %>
        <% if(listing.reviews.length > 0){ 
            let totalRating = listing.reviews.reduce((sum, r) => sum + r.rating, 0);
            let avgRating = (totalRating / listing.reviews.length).toFixed(1);
        %>
          <span class="badge bg-warning text-dark">
            <i class="fa-solid fa-star"></i> <%= avgRating %>
          </span>
        <% } %>
      </h2>
      <p class="text-muted mb-1"><i class="fa-solid fa-user"></i> Owned by <%= listing.owner ? listing.owner.username : "Unknown" %></p>
      <p class="text-muted mb-1"><i class="fa-solid fa-tag"></i> Category: <%= listing.category || "Not specified" %></p>
      <p class="text-muted mb-2">
        <i class="fa-solid fa-user-check"></i> Status: <%= listing.isAvailable ? "Available" : "Booked" %>
      </p>
      <p class="text-muted"><i class="fa-solid fa-location-dot text-danger"></i> <%= listing.location %>, <%= listing.country %></p>

      <hr />

      <!-- DESCRIPTION -->
      <h4 class="fw-semibold">About this place</h4>
      <p class="text-muted"><%= listing.description %></p>

      <hr />

      <!-- MAP -->
      <h4 class="fw-semibold mt-4">Where you’ll be</h4>
      <div id="map" class="map-box"></div>

      <hr />

      <!-- REVIEWS -->
      <h4 class="fw-semibold mt-4">Reviews</h4>

      <% if(currentUser){ %>
        <hr />
        <h5>Leave a Review</h5>
        <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
          <!-- Rating -->
          <div class="mb-3 mt-3">
            <label for="rating" class="form-label">Rating</label>
            <fieldset class="starability-slot">
              <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
              <input type="radio" id="rate1" name="review[rating]" value="1" /><label for="rate1" title="Terrible">1 star</label>
              <input type="radio" id="rate2" name="review[rating]" value="2" /><label for="rate2" title="Not good">2 stars</label>
              <input type="radio" id="rate3" name="review[rating]" value="3" /><label for="rate3" title="Average">3 stars</label>
              <input type="radio" id="rate4" name="review[rating]" value="4" /><label for="rate4" title="Very good">4 stars</label>
              <input type="radio" id="rate5" name="review[rating]" value="5" /><label for="rate5" title="Amazing">5 stars</label>
            </fieldset>
          </div>
          <!-- Comment -->
          <div class="mb-3 mt-3">
            <label for="comment" class="form-label">Comment</label>
            <textarea name="review[comment]" id="comment" rows="4" class="form-control" placeholder="Write your feedback here..." required></textarea>
            <div class="invalid-feedback">Please add a comment for your review</div>
          </div>
          <button class="btn btn-outline-dark">Submit</button>
          <hr />
        </form>
      <% } else { %>
        <form action="/login"><b>Kindly <a href="/login">login</a> to write a review</b></form>
        <hr />
      <% } %>

      <!-- Display All Reviews -->
      <% if(listing.reviews.length > 0){ %>
        <div class="row">
          <p><b>All Reviews</b></p>
          <% listing.reviews.forEach(review => { %>
            <div class="card col-5 ms-3 mb-3 review-card">
              <div class="card-body">
                <h5 class="card-title">@<%= review.author.username %></h5>
                <p class="starability-result card-text" data-rating="<%= review.rating %>"></p>
                <p class="card-text"><%= review.comment %></p>
                <% if(currentUser && review.author._id.equals(currentUser._id)){ %>
                  <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
                    <button class="btn btn-sm btn-dark">Delete</button>
                  </form>
                <% } %>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>

    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="col-lg-4 mt-4 mt-lg-0">
      <div class="sidebar-box">

        <!-- Price Box -->
        <div class="price-box mb-4">
          <h4 class="fw-bold">₹ <%= listing.price.toLocaleString("en-IN") %> / night</h4>
          <% if(listing.minStay){ %>
            <p class="small text-muted">Minimum stay: <%= listing.minStay %> nights</p>
          <% } %>
          <button class="btn btn-danger w-100 mt-3 py-2">Reserve</button>
          <p class="mt-2 text-center text-muted small">You won’t be charged yet</p>
        </div>
         <% if(currentUser && listing.owner._id.equals(currentUser._id)){ %>
             <div class="d-flex mb-3 mt-2 gap-2">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-primary">Edit Listing</a>
             <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this listing?');">
            <button class="btn btn-outline-danger">Delete Listing</button>
        </form>
      </div>
   <% } %>
        <!-- Amenities -->
        <h5 class="fw-semibold mb-3">Amenities</h5>
        <div class="amenities-grid">
          <% const amenities = listing.amenities || ["Wifi","TV","Parking","AC"]; %>
          <% amenities.forEach(a => { %>
            <div><i class="fa-solid fa-check text-success"></i> <%= a %></div>
          <% }) %>
        </div>

        <hr />

        <!-- House Info -->
        <h5 class="fw-semibold mb-2">House Info</h5>
        <ul class="list-unstyled text-muted small">
          <li><i class="fa-solid fa-user-group me-2"></i> Max Guests: <%= listing.maxGuests || "Not specified" %></li>
          <li><i class="fa-solid fa-clock me-2"></i> Check-in: <%= listing.checkIn || "Flexible" %></li>
          <li><i class="fa-solid fa-clock me-2"></i> Check-out: <%= listing.checkOut || "Flexible" %></li>
          <li><i class="fa-solid fa-ban me-2"></i> Pets: <%= listing.petsAllowed ? "Allowed" : "Not Allowed" %></li>
          <li><i class="fa-solid fa-ban me-2"></i> Smoking: <%= listing.smokingAllowed ? "Allowed" : "Not Allowed" %></li>
        </ul>

        <hr />

        <!-- Reviews Summary -->
        <h5 class="fw-semibold mb-2">Reviews Summary</h5>
        <% if(listing.reviews.length > 0){ 
            const starCount=[0,0,0,0,0]; 
            listing.reviews.forEach(r=>{ starCount[r.rating-1]++; });
        %>
          <% for(let i=5;i>0;i--){ %>
            <div class="d-flex align-items-center mb-1">
              <span class="me-2"><%= i %> <i class="fa-solid fa-star text-warning"></i></span>
              <div class="progress w-100">
                <div class="progress-bar bg-warning" role="progressbar" style="width: <%= (starCount[i-1]/listing.reviews.length*100) %>%"></div>
              </div>
              <span class="ms-2 text-muted small"><%= starCount[i-1] %></span>
            </div>
          <% } %>
        <% } else { %>
          <p class="text-muted small">No reviews yet</p>
        <% } %>

        <hr/>

        <!-- Nearby Attractions -->
        <h5 class="fw-semibold mb-2">Nearby Attractions</h5>
        <ul class="list-unstyled text-muted small">
          <% const nearby = listing.nearbyPlaces || ["City Center", "Famous Park", "Popular Museum"]; %>
          <% nearby.forEach(place=>{ %>
            <li><i class="fa-solid fa-location-dot me-2"></i> <%= place %></li>
          <% }) %>
        </ul>

        <hr/>

        <!-- Owner Info -->
        <div class="owner-info">
          <h6 class="fw-semibold">Hosted by</h6>
          <p class="mb-0"><i class="fa-solid fa-user"></i> <%= listing.owner.username %></p>
          <p class="small text-muted"><%= listing.owner.email %></p>
        </div>

        <hr/>

        <!-- Find Nearest Hotels -->
        <% if (currentUser) { %>
          <button id="findNearestBtn" class="btn btn-warning w-100 mt-3">Find Nearest Hotels</button>
        <% } else { %>
          <p class="mt-3 small text-muted"><a href="/login" style="text-decoration:none;">Login</a> to find nearest hotels</p>
        <% } %>

      </div>
    </div>

  </div>
</div>

<!-- Map variables -->
<script>
  const ownerListings = <%- JSON.stringify(ownerListings.map(l => ({
      id: l._id.toString(),
      title: l.title,
      location: l.location,
      coordinates: [l.geometry.coordinates[1], l.geometry.coordinates[0]]
  }))) %>;
  const currentListingId = "<%= listing._id %>";
</script>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/map.js"></script>
<script>
  if (ownerListings.length) {
      initMap(ownerListings, currentListingId);
  }
</script>