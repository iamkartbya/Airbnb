<% layout("layouts/boilerplate") %>

<div class="container py-4">
  <div class="card shadow-sm p-4 profile-card mx-auto">
    <h4 class="mb-3 text-brand">Edit Profile</h4>

    <form action="/profile/<%= currentUser._id %>?_method=PUT"
          method="POST"
          enctype="multipart/form-data"
          id="editProfileForm">

      <div class="row g-4">

        <!-- Avatar -->
        <div class="col-12 col-md-4 d-flex flex-column align-items-center">

          <div class="avatar-wrapper mb-3">
            <img id="avatarPreview"
                 src="<%= currentUser.avatar?.url || '/images/default-avatar.png' %>"
                 alt="Avatar"
                 class="avatar-img">
          </div>

          <div class="upload-controls d-flex flex-wrap justify-content-center gap-2 mb-2">
            <label class="btn btn-outline-secondary btn-sm upload-btn">
              <i class="fa-solid fa-upload me-1"></i> Change
              <input type="file" name="avatar" id="avatarInput" accept="image/*">
            </label>

            <button type="button"
                    id="removeAvatarBtn"
                    class="btn btn-outline-danger btn-sm">
              Remove
            </button>
          </div>

          <p class="small text-muted text-center">
            JPG / PNG â€” max 2MB
          </p>
        </div>

        <!-- Profile Fields -->
        <div class="col-12 col-md-8">

          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input type="text"
                   name="name"
                   class="form-control"
                   value="<%= currentUser.name %>">
          </div>

          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text"
                   name="username"
                   class="form-control"
                   required
                   value="<%= currentUser.username %>">
          </div>

          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email"
                   name="email"
                   class="form-control"
                   required
                   value="<%= currentUser.email %>">
          </div>

          <div class="mb-3">
            <label class="form-label">About</label>
            <textarea name="bio"
                      class="form-control"
                      rows="3"
                      placeholder="Tell visitors about yourself..."><%= currentUser.bio || '' %></textarea>
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <a href="/profile" class="btn btn-secondary flex-grow-1 flex-md-grow-0">Cancel</a>
            <button type="submit"
                    class="btn btn-brand flex-grow-1 flex-md-grow-0">
              Save Changes
            </button>
          </div>

        </div>
      </div>

    </form>
  </div>
</div>


<script>
const avatarInput = document.getElementById('avatarInput');
const avatarPreview = document.getElementById('avatarPreview');
const removeBtn = document.getElementById('removeAvatarBtn');

// Preview + Upload
avatarInput?.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  if (file.size > 2 * 1024 * 1024) {
    alert('Image too large. Max 2MB.');
    avatarInput.value = '';
    return;
  }

  // Local preview
  const reader = new FileReader();
  reader.onload = ev => avatarPreview.src = ev.target.result;
  reader.readAsDataURL(file);

  // Upload
  const fd = new FormData();
  fd.append('avatar', file);

  try {
    const res = await fetch('/profile/avatar', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.url) avatarPreview.src = data.url;
  } catch (error) {
    alert('Error uploading avatar');
  }
});

// Remove Avatar
removeBtn?.addEventListener('click', () => {
  avatarPreview.src = '/images/default-avatar.png';
  avatarInput.value = '';

  let flag = document.getElementById('removeAvatarFlag');
  if (!flag) {
    flag = document.createElement('input');
    flag.type = 'hidden';
    flag.name = 'removeAvatar';
    flag.id = 'removeAvatarFlag';
    flag.value = '1';
    document.getElementById('editProfileForm').appendChild(flag);
  }
});
</script>

<style>
.text-brand {
  color: #fe424d;
}

.btn-brand {
  background: #fe424d;
  color: #fff;
}

.profile-card {
  max-width: 700px;
  border-radius: 14px;
}

/* ðŸ“Œ Structured Avatar Box */
.avatar-wrapper {
  width: 140px;
  height: 140px;
  border: 3px solid #fe424d;
  border-radius: 50%;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Hide input inside label */
.upload-btn input {
  display: none;
}

/* Mobile Tweaks */
@media (max-width: 576px) {
  .avatar-wrapper {
    width: 110px;
    height: 110px;
  }
}
</style>
